<Window x:Class="LMStreamer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:commands="clr-namespace:LMStreamer.Commands"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:conv="clr-namespace:LMStreamer.Converters"
        xmlns:local="clr-namespace:LMStreamer"
        mc:Ignorable="d"
        DataContext="{Binding Path=ViewModel, RelativeSource={RelativeSource Self}}"
        Style="{StaticResource MaterialDesignWindow}"
        Title="Leap Motion Streamer"
        Height="300"
        Width="650"
        MinHeight="300"
        MinWidth="650"
        Icon="/assets/images/logo.png">

    <Window.Resources>
        <conv:Negate x:Key="negate"/>
        <conv:BooleanToVisible x:Key="bool2vis"/>
        <conv:BooleanToOpacity x:Key="bool2opacity"/>
        <conv:PalmPositionToCanvas x:Key="palm2canvas"/>
        <conv:PalmPositionToMarkerSize x:Key="palm2markerSize"/>
        <sys:String x:Key="not">False</sys:String>
        <sys:Double x:Key="dimmed">0.5</sys:Double>
        <sys:Double x:Key="canvasSize">140</sys:Double>
        <sys:Boolean x:Key="inverse">True</sys:Boolean>
    </Window.Resources>

    <Grid>
        <StackPanel DataContext="{Binding HandTracker, Mode=OneTime}"
                    HorizontalAlignment="Center"
                    Margin="12">
            <WrapPanel>
                <Label VerticalAlignment="Center"
                       Margin="0,0,12,0"
                       Content="Hand tracker"/>
                <ComboBox Grid.Column="0"
                          Width="120"
                          Margin="4"
                          IsEnabled="{Binding ElementName=tbnToggleTrackingDevice, Path=IsChecked, Converter={StaticResource negate}, Mode=OneWay}"
                          ItemsSource="{Binding HandTrackers, Mode=OneWay}"
                          SelectedItem="{Binding SelectedHandTracker, Mode=TwoWay}"/>
                <ToggleButton Name="tbnToggleTrackingDevice" Grid.Column="1"
                              Margin="12,0,0,0"
                              IsEnabled="{Binding HasSelectedHandTracker, Mode=OneWay}"
                              IsChecked="{Binding IsHandTrackingRunning, Mode=OneWay}"
                              Command="{x:Static commands:ToggleHandTracker.Instance}"/>
            </WrapPanel>

            <Grid>
                <Label Content="Max tracking distance (cm)"
                       VerticalAlignment="Center"
                       IsEnabled="{Binding HasSelectedHandTracker, Mode=OneWay}"/>
                <TextBox HorizontalAlignment="Right"
                         Width="60"
                         Margin="4"
                         IsEnabled="{Binding HasSelectedHandTracker, Mode=OneWay}">
                    <TextBox.Text>
                        <Binding Path="MaxTrackingDistance" UpdateSourceTrigger="PropertyChanged" Mode="TwoWay">
                            <Binding.ValidationRules>
                                <local:RangeRule Min="40" Max="80" ValidatesOnTargetUpdated="True"/>
                            </Binding.ValidationRules>
                        </Binding>
                    </TextBox.Text>
                </TextBox>
            </Grid>
        </StackPanel>

        <StackPanel DataContext="{Binding HandTracker, Mode=OneTime}"
                    VerticalAlignment="Center">
            <StackPanel.Style>
                <Style TargetType="StackPanel">
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HasHandTrackers, Mode=OneWay}" Value="True">
                            <Setter Property="Visibility" Value="Collapsed" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </StackPanel.Style>

            <TextBlock FontSize="46"
                       Foreground="#BBBBBB"
                       HorizontalAlignment="Center"
                       TextAlignment="Center"
                       TextWrapping="Wrap"
                       Text="Hand tracking is not available">
            </TextBlock>
            <Separator Margin="12"
                       MaxWidth="892"/>
            <TextBlock FontSize="16"
                       Foreground="#BBBBBB"
                       HorizontalAlignment="Center"
                       TextWrapping="Wrap"
                       Visibility="{Binding IsHandTrackerReady, Mode=OneWay, Converter={StaticResource bool2vis}, ConverterParameter={StaticResource not}}"
                       Text="Leap Motion is not installed or LeapC.dll is missing">
            </TextBlock>
            <TextBlock FontSize="16"
                       Foreground="#BBBBBB"
                       HorizontalAlignment="Center"
                       TextWrapping="Wrap"
                       Visibility="{Binding IsHandTrackerReady, Mode=OneWay, Converter={StaticResource bool2vis}}"
                       Text="No Leap Motion devices attached">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasHandTrackers, Mode=OneWay}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>
        </StackPanel>

        <Grid Margin="24"
              Opacity="{Binding HandTracker.IsHandTrackingRunning, Mode=OneWay, Converter={StaticResource bool2opacity}, ConverterParameter={StaticResource dimmed}}">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding HandTracker.HasHandTrackers, Mode=OneWay}" Value="False">
                            <Setter Property="Visibility" Value="Collapsed" />
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>

            <Grid DataContext="{Binding HandTracker, Mode=OneTime}">
                <TextBlock FontSize="16"
                           Width="84"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center">
                    <Run Text="X: "/>
                    <Run Text="{Binding HandLocation.Palm.X, StringFormat={}{0:F3}}"/>
                    <LineBreak/>
                    <Run Text="Y: "/>
                    <Run Text="{Binding HandLocation.Palm.Y, StringFormat={}{0:F3}}"/>
                    <LineBreak/>
                    <Run Text="Z: "/>
                    <Run Text="{Binding HandLocation.Palm.Z, StringFormat={}{0:F3}}"/>
                </TextBlock>

                <Canvas Name="canvas"
                        Visibility="{Binding IsHandTrackerReady, Mode=OneWay, Converter={StaticResource bool2vis}}"
                        Width="{Binding Source={StaticResource canvasSize}}"
                        Height="{Binding Source={StaticResource canvasSize}}"
                        Background="LightGray"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Center"
                        ClipToBounds="True">
                    <Ellipse Fill="#FF0090FF"
                             Width="{Binding HandLocation.Palm.Y, Converter={StaticResource palm2markerSize}}"
                             Height="{Binding HandLocation.Palm.Y, Converter={StaticResource palm2markerSize}}">
                        <Canvas.Top>
                            <MultiBinding Converter="{StaticResource palm2canvas}">
                                <Binding Path="HandLocation.Palm.Z"/>
                                <Binding Path="ActualHeight" ElementName="canvas"/>
                                <Binding Path="ActualWidth" RelativeSource="{RelativeSource Self}"/>
                            </MultiBinding>
                        </Canvas.Top>
                        <Canvas.Left>
                            <MultiBinding Converter="{StaticResource palm2canvas}" ConverterParameter="{StaticResource inverse}">
                                <Binding Path="HandLocation.Palm.X"/>
                                <Binding Path="ActualWidth" ElementName="canvas"/>
                                <Binding Path="ActualWidth" RelativeSource="{RelativeSource Self}"/>
                            </MultiBinding>
                        </Canvas.Left>
                    </Ellipse>
                </Canvas>
            </Grid>
            
            <TextBlock DataContext="{Binding Streamer, Mode=OneTime}"
                       FontSize="16"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Bottom">
                <Run Text="Packets sent: "/>
                <Run Text="{Binding PacketsSent, Mode=OneWay, StringFormat={}{0:N0}}"/>
            </TextBlock>
        </Grid>

        <Image x:Name="imgTcpClient"
               DataContext="{Binding TcpServer, Mode=OneTime}"
               Source="{Binding ServerStatusIcon, Mode=OneWay}" 
               Width="32"
               Margin="8"
               VerticalAlignment="Bottom"
               HorizontalAlignment="Left"/>
    </Grid>
</Window>
